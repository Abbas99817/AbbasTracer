<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemical Pump Operation Logger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);
            color: white;
            padding: 25px 30px;
            border-bottom: 4px solid #3498db;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 32px;
            color: #3498db;
        }

        .system-info {
            background-color: #e8f4fc;
            padding: 15px 30px;
            border-bottom: 1px solid #d1e3f1;
            font-size: 15px;
            color: #2c3e50;
        }

        .content-wrapper {
            display: flex;
            flex-wrap: wrap;
            padding: 0;
        }

        .control-panel {
            flex: 1;
            min-width: 350px;
            padding: 30px;
            background-color: #f9fbfd;
            border-right: 1px solid #eaeaea;
        }

        .data-display {
            flex: 2;
            min-width: 500px;
            padding: 30px;
        }

        .panel-title {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title i {
            color: #3498db;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
            transition: border 0.3s;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .rate-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rate-input input {
            flex: 1;
        }

        .unit {
            color: #7f8c8d;
            font-weight: 500;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-export {
            background-color: #9b59b6;
            color: white;
        }

        .btn-export:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .timer-display {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 25px;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .pump-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pump-indicator {
            text-align: center;
            padding: 15px;
            border-radius: 5px;
            flex: 1;
            min-width: 100px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .pump-active {
            background-color: #d5f4e6;
            border-left: 4px solid #2ecc71;
        }

        .pump-inactive {
            background-color: #f8d7da;
            border-left: 4px solid #e74c3c;
        }

        .pump-name {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .pump-rate {
            font-size: 14px;
            color: #7f8c8d;
        }

        .data-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #2c3e50;
            color: white;
            text-align: left;
            padding: 15px;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f7fd;
        }

        .totals-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 30px;
            border-left: 4px solid #3498db;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .total-card {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }

        .total-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin-top: 5px;
        }

        .total-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }

        @media (max-width: 900px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .control-panel {
                border-right: none;
                border-bottom: 1px solid #eaeaea;
            }
        }

        .status-active {
            color: #27ae60;
            font-weight: 600;
        }

        .status-inactive {
            color: #e74c3c;
            font-weight: 600;
        }

        .operation-info {
            display: flex;
            justify-content: space-between;
            background-color: #f0f7ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pump-control-group {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }

        .pump-control-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid;
        }

        .pump-control-group.pump-a h3 {
            border-bottom-color: #3498db;
        }

        .pump-control-group.pump-b h3 {
            border-bottom-color: #e74c3c;
        }

        .simultaneous-control {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
        }

        .comment-group {
            margin-top: 15px;
        }

        .comment-text {
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-top: 5px;
            padding: 5px;
            background-color: #f9f9f9;
            border-radius: 3px;
        }

        .comment-badge {
            background-color: #f1c40f;
            color: #333;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-tint"></i>
                    <h1>Enpro Dual Chemical Pump Operation Logger</h1>
                </div>
                <div class="timer-display" id="currentTime">00:00:00</div>
            </div>
        </header>

        <div class="system-info">
            <p><i class="fas fa-info-circle"></i> System tracks two independent pumps. Each pump can operate simultaneously with different chemicals and rates.</p>
        </div>

        <div class="content-wrapper">
            <div class="control-panel">
                <h2 class="panel-title"><i class="fas fa-sliders-h"></i> Dual Pump Control Panel</h2>
                
                <div class="operation-info">
                    <div>
                        <div class="total-label">System Status</div>
                        <div class="status-inactive" id="operationStatus">IDLE</div>
                    </div>
                    <div>
                        <div class="total-label">Active Pumps</div>
                        <div class="total-value" id="activePumpsCount">0</div>
                    </div>
                    <div>
                        <div class="total-label">Events Logged</div>
                        <div class="total-value" id="eventsCount">0</div>
                    </div>
                </div>

                <!-- Pump A Controls -->
                <div class="pump-control-group pump-a">
                    <h3><i class="fas fa-pump"></i> Pump A Control</h3>
                    
                    <div class="form-group">
                        <label for="chemicalSelectA"><i class="fas fa-flask"></i> Chemical Selection</label>
                        <select id="chemicalSelectA">
                            <option value="CH1">Water Tracer</option>
                            <option value="CH2">Oil Tracer</option>
                            <option value="CH3">Gas Tracer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="rateInputA"><i class="fas fa-tachometer-alt"></i> Pump Rate</label>
                        <div class="rate-input">
                            <input type="number" id="rateInputA" min="1" max="1000" value="100" step="1">
                            <span class="unit">mL/min</span>
                        </div>
                    </div>

                    <div class="comment-group">
                        <label for="commentInputA"><i class="fas fa-comment"></i> Comment (Optional)</label>
                        <textarea id="commentInputA" placeholder="Add comment for this operation..." rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-play-circle"></i> Pump Control</label>
                        <div class="control-buttons">
                            <button class="btn btn-primary" id="startBtnA">
                                <i class="fas fa-play"></i> Start Pump A
                            </button>
                            <button class="btn btn-danger" id="stopBtnA" disabled>
                                <i class="fas fa-stop"></i> Stop Pump A
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pump B Controls -->
                <div class="pump-control-group pump-b">
                    <h3><i class="fas fa-pump"></i> Pump B Control</h3>
                    
                    <div class="form-group">
                        <label for="chemicalSelectB"><i class="fas fa-flask"></i> Chemical Selection</label>
                        <select id="chemicalSelectB">
                            <option value="CH1">Water Tracer</option>
                            <option value="CH2">Oil Tracer</option>
                            <option value="CH3">Gas Tracer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="rateInputB"><i class="fas fa-tachometer-alt"></i> Pump Rate</label>
                        <div class="rate-input">
                            <input type="number" id="rateInputB" min="1" max="1000" value="100" step="1">
                            <span class="unit">mL/min</span>
                        </div>
                    </div>

                    <div class="comment-group">
                        <label for="commentInputB"><i class="fas fa-comment"></i> Comment (Optional)</label>
                        <textarea id="commentInputB" placeholder="Add comment for this operation..." rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-play-circle"></i> Pump Control</label>
                        <div class="control-buttons">
                            <button class="btn btn-primary" id="startBtnB">
                                <i class="fas fa-play"></i> Start Pump B
                            </button>
                            <button class="btn btn-danger" id="stopBtnB" disabled>
                                <i class="fas fa-stop"></i> Stop Pump B
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Simultaneous Control -->
                <div class="simultaneous-control">
                    <div class="form-group">
                        <label><i class="fas fa-bolt"></i> Quick Simultaneous Start</label>
                        <div class="control-buttons">
                            <button class="btn btn-success" id="startBothBtn">
                                <i class="fas fa-play-circle"></i> Start Both Pumps
                            </button>
                            <button class="btn btn-danger" id="stopBothBtn">
                                <i class="fas fa-stop-circle"></i> Stop Both Pumps
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pump Status Indicators -->
                <div class="pump-status">
                    <div class="pump-indicator pump-inactive" id="pumpAStatus">
                        <div class="pump-name">Pump A</div>
                        <div class="pump-rate">Ready</div>
                        <div class="pump-chemical" id="pumpAChemical">-</div>
                    </div>
                    <div class="pump-indicator pump-inactive" id="pumpBStatus">
                        <div class="pump-name">Pump B</div>
                        <div class="pump-rate">Ready</div>
                        <div class="pump-chemical" id="pumpBChemical">-</div>
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-file-export"></i> Export & Report</label>
                    <div class="export-options">
                        <button class="btn btn-export" id="exportPdfBtn">
                            <i class="fas fa-file-pdf"></i> Generate PDF
                        </button>
                        <button class="btn btn-success" id="summaryBtn">
                            <i class="fas fa-chart-bar"></i> View Summary
                        </button>
                        <button class="btn btn-danger" id="resetBtn">
                            <i class="fas fa-redo"></i> Reset Log
                        </button>
                    </div>
                </div>
            </div>

            <div class="data-display">
                <h2 class="panel-title"><i class="fas fa-history"></i> Pumping Event Log</h2>
                
                <div class="data-table-container">
                    <table id="eventLogTable">
                        <thead>
                            <tr>
                                <th>Event #</th>
                                <th>Pump</th>
                                <th>Chemical</th>
                                <th>Rate (mL/min)</th>
                                <th>Start Time</th>
                                <th>Stop Time</th>
                                <th>Duration</th>
                                <th>Volume (mL)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="eventLogBody">
                            <!-- Events will be added here dynamically -->
                        </tbody>
                    </table>
                </div>

                <div class="totals-panel">
                    <h3><i class="fas fa-calculator"></i> Operation Totals</h3>
                    <div class="totals-grid">
                        <div class="total-card">
                            <div class="total-label">Pump A Total Volume</div>
                            <div class="total-value" id="totalPumpA">0 mL</div>
                        </div>
                        <div class="total-card">
                            <div class="total-label">Pump B Total Volume</div>
                            <div class="total-value" id="totalPumpB">0 mL</div>
                        </div>
                        <div class="total-card">
                            <div class="total-label">Water Tracer Total</div>
                            <div class="total-value" id="totalCH1">0 mL</div>
                        </div>
                        <div class="total-card">
                            <div class="total-label">Oil Tracer Total</div>
                            <div class="total-value" id="totalCH2">0 mL</div>
                        </div>
                        <div class="total-card">
                            <div class="total-label">Gas Tracer Total</div>
                            <div class="total-value" id="totalCH3">0 mL</div>
                        </div>
                        <div class="total-card">
                            <div class="total-label">Overall Total</div>
                            <div class="total-value" id="totalOverall">0 mL</div>
                        </div>
                    </div>
                </div>

                <div class="footer">
                    <p><i class="fas fa-exclamation-circle"></i> Each pump operates independently. Both pumps can run simultaneously with different chemicals and rates.</p>
                    <p>All times are recorded in HH:MM:SS format. Volume calculated automatically as Rate Ã— Duration.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for summary -->
    <div class="modal" id="summaryModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-chart-bar"></i> Operation Summary</h2>
            <div id="summaryContent">
                <!-- Summary content will be inserted here -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-export" id="printSummaryBtn">
                    <i class="fas fa-print"></i> Print Summary
                </button>
                <button class="btn btn-primary" id="closeSummaryBtn">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let events = [];
        let activePumps = {
            'A': { active: false, chemical: null, rate: null, startTime: null, comment: null },
            'B': { active: false, chemical: null, rate: null, startTime: null, comment: null }
        };
        let eventCounter = 0;

        // DOM elements
        const currentTimeElement = document.getElementById('currentTime');
        const eventsCountElement = document.getElementById('eventsCount');
        const activePumpsCountElement = document.getElementById('activePumpsCount');
        const operationStatusElement = document.getElementById('operationStatus');
        
        // Pump A elements
        const chemicalSelectA = document.getElementById('chemicalSelectA');
        const rateInputA = document.getElementById('rateInputA');
        const commentInputA = document.getElementById('commentInputA');
        const startBtnA = document.getElementById('startBtnA');
        const stopBtnA = document.getElementById('stopBtnA');
        const pumpAStatus = document.getElementById('pumpAStatus');
        const pumpAChemical = document.getElementById('pumpAChemical');
        
        // Pump B elements
        const chemicalSelectB = document.getElementById('chemicalSelectB');
        const rateInputB = document.getElementById('rateInputB');
        const commentInputB = document.getElementById('commentInputB');
        const startBtnB = document.getElementById('startBtnB');
        const stopBtnB = document.getElementById('stopBtnB');
        const pumpBStatus = document.getElementById('pumpBStatus');
        const pumpBChemical = document.getElementById('pumpBChemical');
        
        // Both pumps control
        const startBothBtn = document.getElementById('startBothBtn');
        const stopBothBtn = document.getElementById('stopBothBtn');
        
        // Display elements
        const eventLogBody = document.getElementById('eventLogBody');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const summaryBtn = document.getElementById('summaryBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        // Total elements
        const totalPumpAElement = document.getElementById('totalPumpA');
        const totalPumpBElement = document.getElementById('totalPumpB');
        const totalCH1Element = document.getElementById('totalCH1');
        const totalCH2Element = document.getElementById('totalCH2');
        const totalCH3Element = document.getElementById('totalCH3');
        const totalOverallElement = document.getElementById('totalOverall');
        
        // Modal elements
        const summaryModal = document.getElementById('summaryModal');
        const summaryContent = document.getElementById('summaryContent');
        const closeSummaryBtn = document.getElementById('closeSummaryBtn');
        const printSummaryBtn = document.getElementById('printSummaryBtn');

        // Chemical display names mapping
        const chemicalNames = {
            'CH1': 'Water Tracer',
            'CH2': 'Oil Tracer',
            'CH3': 'Gas Tracer'
        };

        // Initialize the application
        function init() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Load sample data for demonstration
            loadSampleData();
            
            // Set up event listeners
            setupEventListeners();
            
            // Update totals
            updateTotals();
        }

        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-GB', {hour12: false});
            currentTimeElement.textContent = timeString;
        }

        // Set up event listeners
        function setupEventListeners() {
            // Pump A controls
            startBtnA.addEventListener('click', () => startPumping('A'));
            stopBtnA.addEventListener('click', () => stopPumping('A'));
            
            // Pump B controls
            startBtnB.addEventListener('click', () => startPumping('B'));
            stopBtnB.addEventListener('click', () => stopPumping('B'));
            
            // Both pumps controls
            startBothBtn.addEventListener('click', startBothPumps);
            stopBothBtn.addEventListener('click', stopBothPumps);
            
            // Other buttons
            exportPdfBtn.addEventListener('click', generatePDF);
            summaryBtn.addEventListener('click', showSummary);
            resetBtn.addEventListener('click', resetLog);
            closeSummaryBtn.addEventListener('click', () => {
                summaryModal.style.display = 'none';
            });
            printSummaryBtn.addEventListener('click', printSummary);
        }

        // Start pumping for a specific pump
        function startPumping(pumpId) {
            const chemicalSelect = pumpId === 'A' ? chemicalSelectA : chemicalSelectB;
            const rateInput = pumpId === 'A' ? rateInputA : rateInputB;
            const commentInput = pumpId === 'A' ? commentInputA : commentInputB;
            
            const chemical = chemicalSelect.value;
            const rate = parseFloat(rateInput.value);
            const comment = commentInput.value.trim();
            
            if (!rate || rate <= 0) {
                alert(`Please enter a valid pump rate for Pump ${pumpId} (greater than 0)`);
                return;
            }
            
            // Check if pump is already active
            if (activePumps[pumpId].active) {
                alert(`Pump ${pumpId} is already running.`);
                return;
            }
            
            // Start the pump
            activePumps[pumpId] = {
                active: true,
                chemical: chemical,
                rate: rate,
                startTime: new Date(),
                comment: comment
            };
            
            // Update pump status display
            updatePumpDisplay(pumpId);
            
            // Update system status
            updateSystemStatus();
            
            console.log(`Started Pump ${pumpId} with ${chemicalNames[chemical]} at ${rate} mL/min`);
        }

        // Stop pumping for a specific pump
        function stopPumping(pumpId) {
            if (!activePumps[pumpId].active) {
                alert(`Pump ${pumpId} is not active.`);
                return;
            }
            
            const pump = activePumps[pumpId];
            const stopTime = new Date();
            const duration = (stopTime - pump.startTime) / 1000 / 60; // in minutes
            const volume = pump.rate * duration;
            
            // Add event to log
            addEventToLog(pumpId, pump.chemical, pump.rate, pump.startTime, stopTime, duration, volume, pump.comment);
            
            // Stop the pump
            activePumps[pumpId].active = false;
            
            // Clear the comment field for this pump
            if (pumpId === 'A') {
                commentInputA.value = '';
            } else {
                commentInputB.value = '';
            }
            
            // Update pump status display
            updatePumpDisplay(pumpId);
            
            // Update system status
            updateSystemStatus();
            
            console.log(`Stopped Pump ${pumpId}. Duration: ${duration.toFixed(2)} min, Volume: ${volume.toFixed(2)} mL`);
        }

        // Start both pumps simultaneously
        function startBothPumps() {
            startPumping('A');
            startPumping('B');
        }

        // Stop both pumps simultaneously
        function stopBothPumps() {
            if (activePumps['A'].active) stopPumping('A');
            if (activePumps['B'].active) stopPumping('B');
        }

        // Update pump display status
        function updatePumpDisplay(pumpId) {
            const pump = activePumps[pumpId];
            const pumpStatus = document.getElementById(`pump${pumpId}Status`);
            const pumpChemical = document.getElementById(`pump${pumpId}Chemical`);
            const startBtn = document.getElementById(`startBtn${pumpId}`);
            const stopBtn = document.getElementById(`stopBtn${pumpId}`);
            const chemicalSelect = document.getElementById(`chemicalSelect${pumpId}`);
            const rateInput = document.getElementById(`rateInput${pumpId}`);
            const commentInput = document.getElementById(`commentInput${pumpId}`);
            
            if (pump.active) {
                // Pump is active
                pumpStatus.classList.remove('pump-inactive');
                pumpStatus.classList.add('pump-active');
                pumpChemical.textContent = chemicalNames[pump.chemical];
                pumpStatus.querySelector('.pump-rate').textContent = `${pump.rate} mL/min`;
                
                startBtn.disabled = true;
                stopBtn.disabled = false;
                chemicalSelect.disabled = true;
                rateInput.disabled = true;
                commentInput.disabled = true;
            } else {
                // Pump is inactive
                pumpStatus.classList.remove('pump-active');
                pumpStatus.classList.add('pump-inactive');
                pumpChemical.textContent = '-';
                pumpStatus.querySelector('.pump-rate').textContent = 'Ready';
                
                startBtn.disabled = false;
                stopBtn.disabled = true;
                chemicalSelect.disabled = false;
                rateInput.disabled = false;
                commentInput.disabled = false;
            }
        }

        // Update system status
        function updateSystemStatus() {
            const activeCount = (activePumps['A'].active ? 1 : 0) + (activePumps['B'].active ? 1 : 0);
            activePumpsCountElement.textContent = activeCount;
            
            if (activeCount > 0) {
                operationStatusElement.textContent = 'ACTIVE';
                operationStatusElement.className = 'status-active';
            } else {
                operationStatusElement.textContent = 'IDLE';
                operationStatusElement.className = 'status-inactive';
            }
        }

        // Add an event to the log
        function addEventToLog(pumpId, chemical, rate, startTime, stopTime, duration, volume, comment) {
            eventCounter++;
            
            const event = {
                id: eventCounter,
                pumpId: pumpId,
                chemical: chemical,
                rate: rate,
                startTime: startTime,
                stopTime: stopTime,
                duration: duration,
                volume: volume,
                comment: comment
            };
            
            events.push(event);
            
            // Add row to table
            const row = document.createElement('tr');
            
            // Format time strings
            const startTimeStr = startTime.toLocaleTimeString('en-GB', {hour12: false});
            const stopTimeStr = stopTime.toLocaleTimeString('en-GB', {hour12: false});
            const durationStr = `${duration.toFixed(2)} min`;
            const volumeStr = `${volume.toFixed(2)} mL`;
            
            row.innerHTML = `
                <td>${eventCounter}</td>
                <td>Pump ${pumpId}</td>
                <td>${chemicalNames[chemical]}</td>
                <td>${rate}</td>
                <td>${startTimeStr}</td>
                <td>${stopTimeStr}</td>
                <td>${durationStr}</td>
                <td>${volumeStr}</td>
                <td>
                    <button class="btn btn-danger" onclick="deleteEvent(${eventCounter})" style="padding: 5px 10px; font-size: 12px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            eventLogBody.appendChild(row);
            
            // Update events count
            eventsCountElement.textContent = events.length;
            
            // Update totals
            updateTotals();
        }

        // Delete an event from the log
        function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event?')) {
                return;
            }
            
            // Remove event from array
            events = events.filter(event => event.id !== eventId);
            
            // Rebuild table
            rebuildEventTable();
            
            // Update events count
            eventsCountElement.textContent = events.length;
            
            // Update totals
            updateTotals();
        }

        // Rebuild the event table
        function rebuildEventTable() {
            // Clear table
            eventLogBody.innerHTML = '';
            
            // Add rows for each event
            events.forEach(event => {
                const row = document.createElement('tr');
                
                // Format time strings
                const startTimeStr = event.startTime.toLocaleTimeString('en-GB', {hour12: false});
                const stopTimeStr = event.stopTime.toLocaleTimeString('en-GB', {hour12: false});
                const durationStr = `${event.duration.toFixed(2)} min`;
                const volumeStr = `${event.volume.toFixed(2)} mL`;
                
                row.innerHTML = `
                    <td>${event.id}</td>
                    <td>Pump ${event.pumpId}</td>
                    <td>${chemicalNames[event.chemical]}</td>
                    <td>${event.rate}</td>
                    <td>${startTimeStr}</td>
                    <td>${stopTimeStr}</td>
                    <td>${durationStr}</td>
                    <td>${volumeStr}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteEvent(${event.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                eventLogBody.appendChild(row);
            });
        }

        // Update totals display
        function updateTotals() {
            let totalPumpA = 0;
            let totalPumpB = 0;
            let totalCH1 = 0;
            let totalCH2 = 0;
            let totalCH3 = 0;
            
            events.forEach(event => {
                if (event.pumpId === 'A') totalPumpA += event.volume;
                if (event.pumpId === 'B') totalPumpB += event.volume;
                if (event.chemical === 'CH1') totalCH1 += event.volume;
                if (event.chemical === 'CH2') totalCH2 += event.volume;
                if (event.chemical === 'CH3') totalCH3 += event.volume;
            });
            
            const totalOverall = totalPumpA + totalPumpB;
            
            totalPumpAElement.textContent = `${totalPumpA.toFixed(2)} mL`;
            totalPumpBElement.textContent = `${totalPumpB.toFixed(2)} mL`;
            totalCH1Element.textContent = `${totalCH1.toFixed(2)} mL`;
            totalCH2Element.textContent = `${totalCH2.toFixed(2)} mL`;
            totalCH3Element.textContent = `${totalCH3.toFixed(2)} mL`;
            totalOverallElement.textContent = `${totalOverall.toFixed(2)} mL`;
        }

        // Generate PDF report
        function generatePDF() {
            if (events.length === 0) {
                alert('No events to export. Please log some pumping events first.');
                return;
            }
            
            // Create a new PDF document
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('portrait');
            
            // Add header
            doc.setFontSize(20);
            doc.setTextColor(44, 62, 80);
            doc.text('Dual Chemical Pump Operation Report', 15, 20);
            
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 15, 30);
            
            // Split events by pump
            const eventsPumpA = events.filter(event => event.pumpId === 'A');
            const eventsPumpB = events.filter(event => event.pumpId === 'B');
            
            // Add summary section
            doc.setFontSize(14);
            doc.setTextColor(44, 62, 80);
            doc.text('Operation Summary', 15, 45);
            
            doc.setFontSize(10);
            doc.setTextColor(80, 80, 80);
            
            // Calculate totals
            let totalPumpA = 0, totalPumpB = 0, totalCH1 = 0, totalCH2 = 0, totalCH3 = 0;
            events.forEach(event => {
                if (event.pumpId === 'A') totalPumpA += event.volume;
                if (event.pumpId === 'B') totalPumpB += event.volume;
                if (event.chemical === 'CH1') totalCH1 += event.volume;
                if (event.chemical === 'CH2') totalCH2 += event.volume;
                if (event.chemical === 'CH3') totalCH3 += event.volume;
            });
            const totalOverall = totalPumpA + totalPumpB;
            
            doc.text(`Total Events: ${events.length}`, 15, 55);
            doc.text(`Pump A Total: ${totalPumpA.toFixed(2)} mL`, 15, 62);
            doc.text(`Pump B Total: ${totalPumpB.toFixed(2)} mL`, 70, 62);
            doc.text(`Water Tracer Total: ${totalCH1.toFixed(2)} mL`, 125, 62);
            doc.text(`Oil Tracer Total: ${totalCH2.toFixed(2)} mL`, 15, 69);
            doc.text(`Gas Tracer Total: ${totalCH3.toFixed(2)} mL`, 70, 69);
            doc.text(`Overall Total: ${totalOverall.toFixed(2)} mL`, 125, 69);
            
            // Add Pump A table
            let yPos = 85;
            if (eventsPumpA.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(52, 152, 219); // Blue for Pump A
                doc.text('Pump A Events', 15, yPos);
                yPos += 5;
                
                // Draw header
                doc.setFontSize(10);
                doc.setFillColor(52, 152, 219);
                doc.setTextColor(255, 255, 255);
                doc.rect(15, yPos, 170, 8, 'F');
                doc.text('Event', 20, yPos + 6);
                doc.text('Chemical', 40, yPos + 6);
                doc.text('Rate', 80, yPos + 6);
                doc.text('Start Time', 100, yPos + 6);
                doc.text('Stop Time', 130, yPos + 6);
                doc.text('Duration', 160, yPos + 6);
                doc.text('Volume', 180, yPos + 6);
                
                yPos += 8;
                
                // Draw rows for Pump A
                doc.setTextColor(0, 0, 0);
                eventsPumpA.forEach((event, i) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Alternate row colors
                    if (i % 2 === 0) {
                        doc.setFillColor(240, 240, 240);
                        doc.rect(15, yPos, 170, 8, 'F');
                    }
                    
                    doc.text(event.id.toString(), 20, yPos + 6);
                    doc.text(chemicalNames[event.chemical], 40, yPos + 6);
                    doc.text(event.rate.toString(), 80, yPos + 6);
                    doc.text(event.startTime.toLocaleTimeString('en-GB', {hour12: false}), 100, yPos + 6);
                    doc.text(event.stopTime.toLocaleTimeString('en-GB', {hour12: false}), 130, yPos + 6);
                    doc.text(`${event.duration.toFixed(2)} min`, 160, yPos + 6);
                    doc.text(`${event.volume.toFixed(2)} mL`, 180, yPos + 6);
                    
                    yPos += 8;
                    
                    // Add comment if exists
                    if (event.comment && event.comment.trim() !== '') {
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Comment: ${event.comment}`, 20, yPos + 4);
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        yPos += 5;
                    }
                });
                
                yPos += 10;
            }
            
            // Add Pump B table
            if (eventsPumpB.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(231, 76, 60); // Red for Pump B
                doc.text('Pump B Events', 15, yPos);
                yPos += 5;
                
                // Draw header
                doc.setFontSize(10);
                doc.setFillColor(231, 76, 60);
                doc.setTextColor(255, 255, 255);
                doc.rect(15, yPos, 170, 8, 'F');
                doc.text('Event', 20, yPos + 6);
                doc.text('Chemical', 40, yPos + 6);
                doc.text('Rate', 80, yPos + 6);
                doc.text('Start Time', 100, yPos + 6);
                doc.text('Stop Time', 130, yPos + 6);
                doc.text('Duration', 160, yPos + 6);
                doc.text('Volume', 180, yPos + 6);
                
                yPos += 8;
                
                // Draw rows for Pump B
                doc.setTextColor(0, 0, 0);
                eventsPumpB.forEach((event, i) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Alternate row colors
                    if (i % 2 === 0) {
                        doc.setFillColor(240, 240, 240);
                        doc.rect(15, yPos, 170, 8, 'F');
                    }
                    
                    doc.text(event.id.toString(), 20, yPos + 6);
                    doc.text(chemicalNames[event.chemical], 40, yPos + 6);
                    doc.text(event.rate.toString(), 80, yPos + 6);
                    doc.text(event.startTime.toLocaleTimeString('en-GB', {hour12: false}), 100, yPos + 6);
                    doc.text(event.stopTime.toLocaleTimeString('en-GB', {hour12: false}), 130, yPos + 6);
                    doc.text(`${event.duration.toFixed(2)} min`, 160, yPos + 6);
                    doc.text(`${event.volume.toFixed(2)} mL`, 180, yPos + 6);
                    
                    yPos += 8;
                    
                    // Add comment if exists
                    if (event.comment && event.comment.trim() !== '') {
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Comment: ${event.comment}`, 20, yPos + 4);
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        yPos += 5;
                    }
                });
            }
            
            // Add footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.text('Enpro Dual Chemical Pump Operation Logger - Confidential Report', 15, 290);
                doc.text(`Page ${i} of ${pageCount}`, 190, 290);
            }
            
            // Save the PDF
            doc.save(`Dual_Pump_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
            
            console.log('PDF generated successfully');
        }

        // Show summary modal
        function showSummary() {
            if (events.length === 0) {
                alert('No events to summarize. Please log some pumping events first.');
                return;
            }
            
            // Calculate totals
            let totalPumpA = 0, totalPumpB = 0;
            let eventsPumpA = 0, eventsPumpB = 0;
            let totalCH1 = 0, totalCH2 = 0, totalCH3 = 0;
            let eventsCH1 = 0, eventsCH2 = 0, eventsCH3 = 0;
            
            events.forEach(event => {
                if (event.pumpId === 'A') {
                    totalPumpA += event.volume;
                    eventsPumpA++;
                }
                if (event.pumpId === 'B') {
                    totalPumpB += event.volume;
                    eventsPumpB++;
                }
                if (event.chemical === 'CH1') {
                    totalCH1 += event.volume;
                    eventsCH1++;
                }
                if (event.chemical === 'CH2') {
                    totalCH2 += event.volume;
                    eventsCH2++;
                }
                if (event.chemical === 'CH3') {
                    totalCH3 += event.volume;
                    eventsCH3++;
                }
            });
            
            const totalOverall = totalPumpA + totalPumpB;
            const totalEvents = events.length;
            
            // Calculate operation duration
            let earliestTime = new Date();
            let latestTime = new Date(0);
            
            events.forEach(event => {
                if (event.startTime < earliestTime) earliestTime = event.startTime;
                if (event.stopTime > latestTime) latestTime = event.stopTime;
            });
            
            const operationDuration = (latestTime - earliestTime) / 1000 / 60; // in minutes
            
            // Build summary HTML
            let summaryHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">Operation Overview</h3>
                    <p><strong>Total Events:</strong> ${totalEvents}</p>
                    <p><strong>Pump A Events:</strong> ${eventsPumpA}</p>
                    <p><strong>Pump B Events:</strong> ${eventsPumpB}</p>
                    <p><strong>Operation Duration:</strong> ${operationDuration.toFixed(2)} minutes</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">Volume Summary by Pump</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Pump</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Events</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Total Volume (mL)</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">Pump A</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${eventsPumpA}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${totalPumpA.toFixed(2)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${totalOverall > 0 ? ((totalPumpA/totalOverall)*100).toFixed(1) : 0}%</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">Pump B</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${eventsPumpB}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${totalPumpB.toFixed(2)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${totalOverall > 0 ? ((totalPumpB/totalOverall)*100).toFixed(1) : 0}%</td>
                            </tr>
                            <tr style="background-color: #f9f9f9; font-weight: bold;">
                                <td style="padding: 8px; border: 1px solid #ddd;">TOTAL</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${totalEvents}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${totalOverall.toFixed(2)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">100%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div>
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">Chemical Usage Summary</h3>
                    <p><strong>Water Tracer:</strong> ${eventsCH1} events, ${totalCH1.toFixed(2)} mL</p>
                    <p><strong>Oil Tracer:</strong> ${eventsCH2} events, ${totalCH2.toFixed(2)} mL</p>
                    <p><strong>Gas Tracer:</strong> ${eventsCH3} events, ${totalCH3.toFixed(2)} mL</p>
                </div>
            `;
            
            summaryContent.innerHTML = summaryHTML;
            summaryModal.style.display = 'flex';
        }

        // Print summary
        function printSummary() {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Dual Pump Operation Summary</title>');
            printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>Dual Chemical Pump Operation Summary</h1>');
            printWindow.document.write(summaryContent.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        // Reset the entire log
        function resetLog() {
            if (!confirm('Are you sure you want to reset the entire log? This action cannot be undone.')) {
                return;
            }
            
            events = [];
            eventCounter = 0;
            activePumps = {
                'A': { active: false, chemical: null, rate: null, startTime: null, comment: null },
                'B': { active: false, chemical: null, rate: null, startTime: null, comment: null }
            };
            
            // Reset UI
            eventLogBody.innerHTML = '';
            eventsCountElement.textContent = '0';
            updateTotals();
            
            // Reset pump status displays
            updatePumpDisplay('A');
            updatePumpDisplay('B');
            
            // Reset comment fields
            commentInputA.value = '';
            commentInputB.value = '';
            
            // Reset system status
            updateSystemStatus();
            
            console.log('Log reset');
        }

        // Load sample data for demonstration
        function loadSampleData() {
            // Add some sample events for demonstration
            const now = new Date();
            
            // Sample event 1: Pump A with CH1 at 120 mL/min for 6 minutes
            const start1 = new Date(now.getTime() - 3600000); // 1 hour ago
            const stop1 = new Date(start1.getTime() + 6*60000);
            addEventToLog('A', 'CH1', 120, start1, stop1, 6, 720, 'Initial calibration run');
            
            // Sample event 2: Pump B with CH2 at 200 mL/min for 8 minutes (simultaneous)
            const start2 = new Date(start1.getTime() + 1*60000);
            const stop2 = new Date(start2.getTime() + 8*60000);
            addEventToLog('B', 'CH2', 200, start2, stop2, 8, 1600, 'Oil tracer injection for well #3');
            
            // Sample event 3: Pump A with CH3 at 150 mL/min for 3 minutes
            const start3 = new Date(start1.getTime() + 18*60000);
            const stop3 = new Date(start3.getTime() + 3*60000);
            addEventToLog('A', 'CH3', 150, start3, stop3, 3, 450, 'Gas tracer test - high pressure');
            
            // Sample event 4: Pump B with CH1 at 100 mL/min for 6 minutes
            const start4 = new Date(start1.getTime() + 34*60000);
            const stop4 = new Date(start4.getTime() + 6*60000);
            addEventToLog('B', 'CH1', 100, start4, stop4, 6, 600, 'Water tracer for well #5');
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>